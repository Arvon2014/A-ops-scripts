upstream tomcatcluster
{
   #Usergrid lists
{% for host in groups['appservers'] %}
{% if loop.length >= 1 %}
   server {{ hostvars[host]['hostname'] }}:{{ hostvars[host]['usergrid_host']['port'] }} max_fails=50 weight=3;
{% endif %}
{% endfor %}

    keepalive 16;

    check interval=3000 rise=1 fall=5 timeout=2000 type=http;
    check_http_send "HEAD /status HTTP/1.0\r\n\r\n";
    check_http_expect_alive http_2xx;

}
include conf.d/include/a1-map-uri-easemob_api;

server
{
    listen {{api_port}};
    charset UTF-8;

#    listen 443 ssl backlog=4096;
#    ssl_certificate /data/apps/config/nginx/https/api.ssl.crt;
#    ssl_certificate_key /data/apps/config/nginx/https/api.ssl.key;

    server_name {{api_site}};
    index index.html index.htm index.jsp index.do default.jsp default.do index.php;

    root  /data/apps/data/nginx;

    access_log /data/apps/log/nginx/usergrid-access.log main;
    error_log /data/apps/log/nginx/usergrid-error.log;

    include conf.d/include/proxy.cfg;

    if ( $request_uri ~* '//' ) {
        return 404 '{"error":"url is invalid"}';
    }

    location / {
        include conf.d/include/a1-core;
        include conf.d/include/a1-mp3header;
        proxy_pass http://tomcatcluster;
    }

    location /favicon.ico {
        return 200 '';
    }
    location /robots.txt {
        return 200 "User-agent: *\nDisallow: /";
    }
}

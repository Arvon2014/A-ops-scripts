upstream ejabberdcluster
{
   #ejabberd list
{% for host in groups['ejabberd_conn'] %}
{% if loop.length >= 1 %}
   server {{ hostvars[host]['hostname'] }}:5280 max_fails=15 fail_timeout=5s;
{% endif %}
{% endfor %}
    keepalive 10;
}


server
{
    listen {{imapi_port}};
    charset UTF-8;
    server_name {{imapi_site}};
    index index.html index.htm index.jsp index.do default.jsp default.do index.php;

    access_log /data/apps/log/nginx/im1-access.log main;
    error_log /data/apps/log/nginx/im1-error.log;

    proxy_connect_timeout 30;
    proxy_read_timeout 600;
    proxy_send_timeout 20;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;

    location /http-bind {
        proxy_pass http://ejabberdcluster;
        proxy_read_timeout 90;
    }
    location /ws {
        proxy_pass http://ejabberdcluster;
        proxy_http_version 1.1;

        proxy_set_header Connection "keep-alive, Upgrade";
        proxy_set_header Upgrade "websocket";
        proxy_read_timeout 300;
    }
    location / {
        proxy_pass http://ejabberdcluster;
        proxy_upstream_tries 2;
    }
}
